<div class="section">
  <h2>Order Imported: <%= @order.display_name %></h2>
  <p>We've imported your order. Please review the items below and take any required actions before submitting for production.</p>
</div>

<div class="btn-wrapper">
  <a href="<%= order_url(@order) %>" class="btn">Review order</a>
</div>

<% if @order.note.present? %>
  <div class="info-box">
    <div class="info-box-title">Order Notes</div>
    <div class="info-box-content"><%= @order.note %></div>
  </div>
<% end %>
<% items = @order.active_order_items.includes(:product_variant, :variant_mapping).order(:id) %>
<% unknown_items = items.select(&:unknown_product?) %>
<% fulfillable_items = items.select(&:fulfillable?) %>
<% items_without_mapping = fulfillable_items.reject { |item| item.has_variant_mapping? && item.country_matches_variant_mapping? } %>
<% items_missing_images = fulfillable_items.select { |item| item.has_variant_mapping? && item.country_matches_variant_mapping? && item.variant_mapping.image.blank? } %>
<h3>Order summary</h3>

<% if unknown_items.any? %>
  <div class="alert alert-error">
    Unknown products: <%= pluralize(unknown_items.count, 'item') %> could not be matched to products in your store. Please import missing products.
  </div>
<% elsif items_without_mapping.any? %>
  <div class="alert alert-warning">
    Action needed: <%= pluralize(items_without_mapping.sum(&:quantity), 'item') %> require a connected product and image.
  </div>
<% elsif items_missing_images.any? %>
  <div class="alert alert-warning">
    Missing images: <%= pluralize(items_missing_images.sum(&:quantity), 'item') %> require an artwork image.
  </div>
<% else %>
  <div class="alert alert-success">
    All items are ready to be fulfilled but we still need approval to proceed.
  </div>
<% end %>

<table class="order-items" cellpadding="0" cellspacing="0" border="0">
  <% items.each do |item| %>
    <tr>
      <td class="order-item">
        <table width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td class="item-image-cell">
              <table class="item-image-wrapper" cellpadding="0" cellspacing="0" border="0">
                <tr>
                  <td align="center" valign="middle">
                    <% if item.framed_preview_url(size: 128) %>
                      <%= image_tag item.framed_preview_url(size: 128), alt: item.display_name, width: "64", height: "64", class: "item-image" %>
                    <% else %>
                      <span class="item-image-placeholder">No image</span>
                    <% end %>
                  </td>
                </tr>
              </table>
            </td>
            <td class="item-details">
              <table width="100%" cellpadding="0" cellspacing="0" border="0">
                <tr>
                  <td valign="top">
                    <div class="item-name"><%= item.display_name %></div>
                    <% if item.sku.present? %>
                      <div class="item-sku">SKU: <%= item.sku %></div>
                    <% end %>
                    <div class="item-meta">
                      <span>Qty: <%= item.quantity %></span>
                    </div>
                  </td>
                  <td class="item-status-cell" width="150">
                    <% if item.unknown_product? %>
                      <span class="badge badge-error">Unknown Product</span>
                    <% elsif item.fulfillable? && item.variant_mapping && item.country_matches_variant_mapping? && item.variant_mapping.image.present? %>
                      <span class="badge badge-success">Ready</span>
                    <% elsif item.fulfillable? && item.variant_mapping && item.country_matches_variant_mapping? && item.variant_mapping.image.blank? %>
                      <span class="badge badge-warning">Missing Image</span>
                    <% elsif item.fulfillable? && (!item.variant_mapping || !item.country_matches_variant_mapping?) %>
                      <span class="badge badge-warning">Incomplete</span>
                    <% else %>
                      <span class="badge badge-neutral">Fulfilment Disabled</span>
                    <% end %>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  <% end %>
</table>
