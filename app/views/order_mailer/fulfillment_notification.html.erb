<div class="section">
  <h2>Order <%= @order.display_name %> - Items Fulfilled</h2>
  <p>Good news! Some items from your order have been fulfilled and are on their way.</p>
  <% if @fulfillment.tracking_number.present? %>
    <p style="margin: 24px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.5;">
      <% if @fulfillment.tracking_company.present? %>
        <%= @fulfillment.tracking_company %> tracking number: 
      <% else %>
        Tracking number: 
      <% end %>
      <% if @fulfillment.tracking_url.present? %>
        <a href="<%= @fulfillment.tracking_url %>" style="color: #5469d4; text-decoration: none;"><%= @fulfillment.tracking_number %></a>
      <% else %>
        <%= @fulfillment.tracking_number %>
      <% end %>
    </p>
  <% end %>
  <% if @order.note.present? %>
    <div class="info-box" style="margin-top: 24px;">
      <div class="info-box-title">Order Notes</div>
      <div class="info-box-content"><%= @order.note %></div>
    </div>
  <% end %>
</div>

<div class="section">
  <h3>Fulfilled Items</h3>
  <table class="order-items" cellpadding="0" cellspacing="0" border="0">
    <% @fulfillment.fulfillment_line_items.includes(order_item: [:product_variant, :variant_mapping]).each do |line_item| %>
      <% item = line_item.order_item %>
      <tr>
        <td class="order-item">
          <table width="100%" cellpadding="0" cellspacing="0" border="0">
            <tr>
              <td class="item-image-cell">
                <table class="item-image-wrapper" cellpadding="0" cellspacing="0" border="0">
                  <tr>
                    <td align="center" valign="middle">
                      <% if item.framed_preview_url(size: 128) %>
                        <%= image_tag item.framed_preview_url(size: 128), alt: item.display_name, width: "64", height: "64", class: "item-image" %>
                      <% else %>
                        <span class="item-image-placeholder">No image</span>
                      <% end %>
                    </td>
                  </tr>
                </table>
              </td>
              <td class="item-details">
                <table width="100%" cellpadding="0" cellspacing="0" border="0">
                  <tr>
                    <td valign="top">
                      <div class="item-name"><%= item.display_name %></div>
                      <% if item.sku.present? %>
                        <div class="item-sku">SKU: <%= item.sku %></div>
                      <% end %>
                      <div class="item-meta">
                        <span>Fulfilled Qty: <%= line_item.quantity %></span>
                      </div>
                    </td>
                    <td class="item-status-cell" width="100">
                      <span class="badge badge-success">Fulfilled</span>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </td>
      </tr>
    <% end %>
  </table>
</div>

<% remaining_items = @order.active_order_items.includes(:product_variant, :variant_mapping).select { |item| item.unfulfilled_quantity > 0 } %>
<% if remaining_items.any? %>
  <div class="section-divider">
    <h3>Remaining Items</h3>
    <p class="section-description">The following items are still being prepared and will be fulfilled separately.</p>
    <table class="order-items" cellpadding="0" cellspacing="0" border="0">
      <% remaining_items.each do |item| %>
        <tr>
          <td class="order-item">
            <table width="100%" cellpadding="0" cellspacing="0" border="0">
              <tr>
                <td class="item-image-cell">
                  <table class="item-image-wrapper" cellpadding="0" cellspacing="0" border="0">
                    <tr>
                      <td align="center" valign="middle">
                        <% if item.framed_preview_url(size: 128) %>
                          <%= image_tag item.framed_preview_url(size: 128), alt: item.display_name, width: "64", height: "64", class: "item-image" %>
                        <% else %>
                          <span class="item-image-placeholder">No image</span>
                        <% end %>
                      </td>
                    </tr>
                  </table>
                </td>
                <td class="item-details">
                  <table width="100%" cellpadding="0" cellspacing="0" border="0">
                    <tr>
                      <td valign="top">
                        <div class="item-name"><%= item.display_name %></div>
                        <% if item.sku.present? %>
                          <div class="item-sku">SKU: <%= item.sku %></div>
                        <% end %>
                        <div class="item-meta">
                          <span>Qty: <%= item.quantity %></span>
                          <% unfulfilled_qty = item.quantity - item.fulfilled_quantity %>
                          <% if unfulfilled_qty > 0 %>
                            <span class="item-unfulfilled">(Unfulfilled: <%= unfulfilled_qty %>)</span>
                          <% end %>
                        </div>
                      </td>
                      <td class="item-status-cell" width="120">
                        <% if item.has_variant_mapping? && item.variant_mapping.image.present? %>
                          <span class="badge badge-info">Ready</span>
                        <% elsif item.has_variant_mapping? && item.variant_mapping.image.blank? %>
                          <span class="badge badge-warning">Missing Image</span>
                        <% else %>
                          <span class="badge badge-warning">Incomplete</span>
                        <% end %>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
<% end %>

<div class="btn-wrapper">
  <a href="<%= order_url(@order) %>" class="btn">View order</a>
</div>

