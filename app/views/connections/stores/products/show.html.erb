<% content_for :title, "#{@product.title} - #{@store.name}" %>

<div class="space-y-8">

  <!-- Reauthentication Warning -->
  <%= render "shared/store_reauthentication_warning", store: @store %>

   <!-- Actions -->
  <div class="flex items-center justify-between">
    <%= link_to connections_store_path(@store), 
        class: "hover:bg-slate-100 hover:text-slate-900 px-4 py-2 rounded-md text-sm font-medium transition-colors" do %>
      ‚Üê Back to <%= @store.name %>
    <% end %>
    
    <!-- Actions Dropdown -->
    <div class="relative" data-dropdown>
      <button 
        type="button"
        <%= 'data-dropdown-trigger' unless @store.needs_reauthentication? %>
        <%= 'disabled' if @store.needs_reauthentication? %>
        <%= 'title="Actions disabled - store needs reauthentication"' if @store.needs_reauthentication? %>
        class="inline-flex items-center px-4 py-2 border rounded-md text-sm font-medium transition-colors <%= @store.needs_reauthentication? ? 'border-slate-200 bg-slate-100 text-slate-400 cursor-not-allowed' : 'border-slate-300 bg-white text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500' %>"
      >
        <span>Actions</span>
        <i class="fa-solid fa-chevron-down ml-2 h-4 w-4"></i>
      </button>

      <!-- Dropdown Menu -->
      <div 
        data-dropdown-menu
        class="hidden absolute right-0 z-10 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none"
      >
        <div class="py-1" role="none">
          <%= link_to toggle_bundles_connections_store_product_path(@store, @product),
              class: "group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors",
              role: "menuitem",
              data: { toggle_bundles_link: true } do %>
            <%= svg_icon('CollectionReferenceIcon', class: 'w-6 h-6 mr-3') %>
            <%= @product.bundles_enabled ? 'Disable' : 'Enable' %> bundles for this product
          <% end %>
          
          <!-- Separator -->
          <div class="border-t border-slate-200 my-1"></div>
          
          <%= link_to sync_from_platform_connections_store_product_path(@store, @product),
              class: "group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors",
              role: "menuitem" do %>
            <%= svg_icon('RefreshIcon', class: 'w-6 h-6 mr-3') %>
            Pull changes from <%= @store.platform.humanize %>
          <% end %>
          
          <% if @product.has_variant_mappings? %>
          <!-- Separator -->
          <div class="border-t border-slate-200 my-1"></div>
            <% if @product.bundles_enabled %>
              <div class="group flex items-center px-4 py-2 text-sm text-slate-400 cursor-not-allowed" role="menuitem" title="Not available when bundles are enabled">
                <%= svg_icon('ImageMagicIcon', class: 'w-6 h-6 mr-3 opacity-50') %>
                Sync all variant mockup images to <%= @store.platform.humanize %>
              </div>
            <% else %>
              <%= link_to sync_variant_mappings_connections_store_product_path(@store, @product),
                  class: "group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors",
                  role: "menuitem",
                  data: { sync_variant_mockups_link: true } do %>
                <%= svg_icon('ImageMagicIcon', class: 'w-6 h-6 mr-3') %>
                Sync all variant mockup images to <%= @store.platform.humanize %>
              <% end %>
            <% end %>
          <% end %>
          
          <% if @product.platform_url.present? %>
            <!-- Separator -->
            <div class="border-t border-slate-200 my-1"></div>
            
            <%= link_to @product.platform_url, 
                target: "_blank", 
                rel: "noopener",
                class: "group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors",
                role: "menuitem" do %>
              <%= svg_icon('ExternalSmallIcon', class: 'w-6 h-6 mr-3') %>
              View in <%= @store.platform.humanize %> admin
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Header -->
  <%= react_component("ProductShowView", {
    product: {
      id: @product.id,
      title: @product.title,
      external_id: @product.external_id,
      handle: @product.handle,
      vendor: @product.vendor,
      featured_image_url: @product.featured_image_url,
      fulfilment_active: @product.fulfilment_active,
      platform_url: @product.platform_url,
      created_at: @product.created_at,
      updated_at: @product.updated_at,
      published_at: @product.published_at,
      bundles_enabled: @product.bundles_enabled
    },
    store: {
      uid: @store.uid,
      name: @store.name,
      platform: @store.platform,
      ai_mapping_enabled: @store.ai_mapping_enabled
    },
    variants: @variants.map do |variant|
      # Get bundle information - ensure bundle exists
      bundle = variant.bundle || variant.create_bundle!(slot_count: 1)
      bundle_mappings = bundle&.variant_mappings&.order(:slot_position) || []
      
      # Filter bundle mappings for current user's country
      user_country_mappings = bundle_mappings.select { |vm| vm.country_code == current_user.country }
      
      # Backward compatibility: also include single variant_mapping
      user_country_mapping = variant.variant_mappings.find_by(country_code: current_user.country, is_default: true)
      
      {
        id: variant.id,
        title: variant.title,
        external_variant_id: variant.external_variant_id,
        fulfilment_active: variant.fulfilment_active,
        bundle: bundle ? {
          id: bundle.id,
          slot_count: bundle.slot_count,
          variant_mappings: user_country_mappings.map do |vm|
            vm.as_json(
              only: [
                :id, :frame_sku_id, :frame_sku_code, :slot_position,
                :frame_sku_title, :frame_sku_cost_cents, :preview_url,
                :frame_sku_description, :frame_sku_long, :frame_sku_short, 
                :frame_sku_unit, :width, :height, :unit, :colour, :country_code
              ],
              methods: [
                :image_id, :image_key, :cx, :cy, :cw, :ch, :cloudinary_id,
                :image_width, :image_height, :image_filename,
                :artwork_preview_thumbnail, :artwork_preview_medium, :artwork_preview_large,
                :framed_preview_thumbnail, :framed_preview_medium, :framed_preview_large,
                :frame_sku_cost_formatted, :frame_sku_cost_dollars, :dimensions_display
              ]
            )
          end
        } : nil,
        variant_mapping: user_country_mapping&.as_json(
          only: [
            :id, :frame_sku_id, :frame_sku_code,
            :frame_sku_title, :frame_sku_cost_cents, :preview_url,
            :frame_sku_description, :frame_sku_long, :frame_sku_short, 
            :frame_sku_unit, :width, :height, :unit, :colour, :country_code
          ],
          methods: [
            :image_id, :image_key, :cx, :cy, :cw, :ch, :cloudinary_id,
            :image_width, :image_height, :image_filename,
            :artwork_preview_thumbnail, :artwork_preview_medium, :artwork_preview_large,
            :framed_preview_thumbnail, :framed_preview_medium, :framed_preview_large,
            :frame_sku_cost_formatted, :frame_sku_cost_dollars, :dimensions_display
          ]
        )
      }
    end,
    variantCount: @variant_count,
    productTypeImages: {
      matted: asset_path('print-frame-matted.jpg'),
      unmatted: asset_path('print-frame-no-mat.jpg'),
      canvas: asset_path('canvas.jpg'),
      printOnly: asset_path('unframed.jpg')
    }
  }) %>

  <!-- Enable Bundles Modal Controller -->
  <%= react_component("EnableBundlesButton", {
    productTitle: @product.title,
    toggleUrl: toggle_bundles_connections_store_product_path(@store, @product),
    bundlesEnabled: @product.bundles_enabled
  }) %>

  <!-- Sync Variant Mockups Modal Controller -->
  <% if @product.has_variant_mappings? && !@product.bundles_enabled %>
    <% variant_mappings_count = @product.product_variants.map(&:default_variant_mapping).compact.count %>
    <%= react_component("SyncVariantMockupsButton", {
      variantMappingsCount: variant_mappings_count,
      syncUrl: sync_variant_mappings_connections_store_product_path(@store, @product),
      storePlatform: @store.platform.humanize
    }) %>
  <% end %>

</div>
